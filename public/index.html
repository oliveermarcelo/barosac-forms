<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>v4 Forms</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a0a0b;--bg2:#111113;--card:#18181b;--border:#27272a;--text:#fafafa;--text2:#a1a1aa;--accent:#ef4444;--success:#22c55e;--warning:#f59e0b}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
.login{min-height:100vh;display:flex;align-items:center;justify-content:center}
.login-box{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:40px;width:100%;max-width:380px}
.login-box h1{text-align:center;color:var(--accent);margin-bottom:8px}
.login-box p{text-align:center;color:var(--text2);margin-bottom:32px;font-size:14px}
.form-group{margin-bottom:20px}
.form-group label{display:block;font-size:14px;margin-bottom:8px;color:var(--text2)}
.form-group input,.form-group select{width:100%;padding:12px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:14px}
.form-group input:focus{outline:none;border-color:var(--accent)}
.btn{padding:12px 20px;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;border:none}
.btn-primary{background:var(--accent);color:#fff;width:100%}
.btn-primary:hover{background:#dc2626}
.btn-secondary{background:var(--card);color:var(--text);border:1px solid var(--border)}
.error{background:rgba(239,68,68,.1);color:var(--accent);padding:12px;border-radius:8px;margin-bottom:20px;display:none;text-align:center}
.error.show{display:block}
.app{display:none;min-height:100vh}
.app.active{display:flex}
.sidebar{width:240px;background:var(--bg2);border-right:1px solid var(--border);padding:20px;display:flex;flex-direction:column}
.logo{color:var(--accent);font-size:18px;font-weight:700;margin-bottom:32px}
.nav-item{padding:12px;border-radius:8px;cursor:pointer;color:var(--text2);margin-bottom:4px}
.nav-item:hover,.nav-item.active{background:var(--card);color:var(--text)}
.nav-item.logout{color:var(--accent);margin-top:auto}
.main{flex:1;padding:32px;overflow-y:auto}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px}
.title{font-size:24px;font-weight:700}
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px}
.stat{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px}
.stat-label{font-size:12px;color:var(--text2);margin-bottom:4px}
.stat-value{font-size:28px;font-weight:700}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden}
.card-header{padding:16px 20px;border-bottom:1px solid var(--border);font-weight:600}
table{width:100%;border-collapse:collapse}
th,td{text-align:left;padding:12px 20px;border-bottom:1px solid var(--border)}
th{font-size:11px;text-transform:uppercase;color:var(--text2)}
tr:last-child td{border-bottom:none}
.badge{padding:4px 8px;border-radius:12px;font-size:11px}
.badge-ok{background:rgba(34,197,94,.15);color:var(--success)}
.badge-wait{background:rgba(245,158,11,.15);color:var(--warning)}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;visibility:hidden}
.modal.active{opacity:1;visibility:visible}
.modal-box{background:var(--card);border:1px solid var(--border);border-radius:16px;width:100%;max-width:500px;max-height:90vh;overflow-y:auto}
.modal-header{display:flex;justify-content:space-between;align-items:center;padding:20px;border-bottom:1px solid var(--border)}
.modal-close{background:none;border:none;color:var(--text2);font-size:24px;cursor:pointer}
.modal-body{padding:20px}
.fields{border:1px solid var(--border);border-radius:8px;margin-bottom:16px}
.field{display:flex;align-items:center;padding:12px;border-bottom:1px solid var(--border)}
.field:last-child{border-bottom:none}
.field-info{flex:1}
.field-name{font-weight:500;font-size:14px}
.field-type{font-size:12px;color:var(--text2)}
.field-del{background:none;border:none;color:var(--text2);cursor:pointer}
.code-box{background:#000;border-radius:8px;margin-top:16px}
.code-header{display:flex;justify-content:space-between;padding:12px;background:var(--bg2)}
.code-content{padding:16px;font-family:monospace;font-size:12px;white-space:pre-wrap;max-height:300px;overflow:auto}
.view{display:none}
.view.active{display:block}
.empty{text-align:center;padding:40px;color:var(--text2)}
.toast{position:fixed;bottom:20px;right:20px;background:var(--card);border:1px solid var(--border);padding:12px 20px;border-radius:8px;z-index:2000}
.actions{display:flex;gap:8px}
@media(max-width:900px){.sidebar{display:none}.stats{grid-template-columns:repeat(2,1fr)}}
</style>
</head>
<body>
<div class="login" id="login">
<div class="login-box">
<h1>üî¥ v4 Forms</h1>
<p>Sistema de Captura de Leads</p>
<div class="error" id="err">Usu√°rio ou senha inv√°lidos</div>
<form id="login-form">
<div class="form-group"><label>Usu√°rio</label><input type="text" id="user" required></div>
<div class="form-group"><label>Senha</label><input type="password" id="pass" required></div>
<button type="submit" class="btn btn-primary" id="btn-login">Entrar</button>
</form>
</div>
</div>

<div class="app" id="app">
<aside class="sidebar">
<div class="logo">üî¥ v4 Forms</div>
<div class="nav-item active" data-v="dash">üìä Dashboard</div>
<div class="nav-item" data-v="forms">üìù Formul√°rios</div>
<div class="nav-item" data-v="leads">üë• Leads</div>
<div class="nav-item" data-v="hooks">üîó Integra√ß√µes</div>
<div class="nav-item logout" onclick="logout()">üö™ Sair</div>
</aside>
<main class="main">
<section id="v-dash" class="view active">
<div class="header"><h1 class="title">Dashboard</h1><button class="btn btn-primary" onclick="openM('form')">+ Novo Formul√°rio</button></div>
<div class="stats">
<div class="stat"><div class="stat-label">Total Leads</div><div class="stat-value" id="st-leads">0</div></div>
<div class="stat"><div class="stat-label">Formul√°rios</div><div class="stat-value" id="st-forms">0</div></div>
<div class="stat"><div class="stat-label">Webhooks</div><div class="stat-value" id="st-hooks">0</div></div>
<div class="stat"><div class="stat-label">Enviados</div><div class="stat-value" id="st-sent">0</div></div>
</div>
<div class="card"><div class="card-header">√öltimos Leads</div><table><thead><tr><th>Nome</th><th>Email</th><th>Formul√°rio</th><th>Data</th><th>Status</th></tr></thead><tbody id="tbl-recent"></tbody></table></div>
</section>
<section id="v-forms" class="view">
<div class="header"><h1 class="title">Formul√°rios</h1><button class="btn btn-primary" onclick="openM('form')">+ Novo</button></div>
<div class="card"><table><thead><tr><th>Nome</th><th>Campos</th><th>Leads</th><th>A√ß√µes</th></tr></thead><tbody id="tbl-forms"></tbody></table></div>
</section>
<section id="v-leads" class="view">
<div class="header"><h1 class="title">Leads</h1><button class="btn btn-secondary" onclick="csvExport()">üì• Exportar</button></div>
<div class="card"><table><thead><tr><th>Nome</th><th>Email</th><th>Tel</th><th>Form</th><th>Data</th><th>Status</th></tr></thead><tbody id="tbl-leads"></tbody></table></div>
</section>
<section id="v-hooks" class="view">
<div class="header"><h1 class="title">Integra√ß√µes</h1></div>
<div class="card" style="padding:20px">
<h3>Webhook Global</h3>
<p style="color:var(--text2);margin:12px 0">Receba leads no Make, n8n ou Zapier</p>
<div class="form-group"><label>URL</label><input type="url" id="hook-url" placeholder="https://hook.make.com/..."></div>
<button class="btn btn-primary" onclick="saveHook()" style="width:auto">Salvar</button>
<div id="hook-list" style="margin-top:20px"></div>
</div>
</section>
</main>
</div>

<div class="modal" id="m-form">
<div class="modal-box">
<div class="modal-header"><h3>Novo Formul√°rio</h3><button class="modal-close" onclick="closeM('form')">√ó</button></div>
<div class="modal-body">
<div class="form-group"><label>Nome</label><input type="text" id="f-name" placeholder="Ex: Contato"></div>
<div class="form-group"><label>Campos</label><div class="fields" id="f-fields"></div><button class="btn btn-secondary" onclick="openM('field')" style="width:100%">+ Campo</button></div>
<button class="btn btn-primary" onclick="createForm()" style="width:100%;margin-top:16px">Criar</button>
</div>
</div>
</div>

<div class="modal" id="m-field">
<div class="modal-box" style="max-width:360px">
<div class="modal-header"><h3>Campo</h3><button class="modal-close" onclick="closeM('field')">√ó</button></div>
<div class="modal-body">
<div class="form-group"><label>Nome</label><input type="text" id="fd-name"></div>
<div class="form-group"><label>Tipo</label><select id="fd-type"><option value="text">Texto</option><option value="email">Email</option><option value="tel">Telefone</option><option value="textarea">Texto longo</option></select></div>
<div class="form-group"><label>Placeholder</label><input type="text" id="fd-ph"></div>
<div class="form-group"><label><input type="checkbox" id="fd-req" checked> Obrigat√≥rio</label></div>
<button class="btn btn-primary" onclick="addField()" style="width:100%">Adicionar</button>
</div>
</div>
</div>

<div class="modal" id="m-code">
<div class="modal-box" style="max-width:700px">
<div class="modal-header"><h3>C√≥digo HTML</h3><button class="modal-close" onclick="closeM('code')">√ó</button></div>
<div class="modal-body">
<p style="color:var(--text2)">Cole na sua landing page:</p>
<div class="code-box"><div class="code-header"><span>HTML</span><button class="btn btn-secondary" onclick="copyCode()">üìã Copiar</button></div><div class="code-content" id="code-out"></div></div>
</div>
</div>
</div>

<script>
const API='/api';
let tk=localStorage.getItem('tk'),D={forms:[],leads:[],stats:{},hooks:[]},TF=[];

async function init(){
  if(!tk)return showLogin();
  try{
    const r=await f('GET','/session');
    r&&r.authenticated?(showApp(),load()):doLogout();
  }catch(e){showLogin();}
}

function showLogin(){document.getElementById('login').style.display='flex';document.getElementById('app').classList.remove('active');}
function showApp(){document.getElementById('login').style.display='none';document.getElementById('app').classList.add('active');}
function doLogout(){tk=null;localStorage.removeItem('tk');showLogin();}

document.getElementById('login-form').onsubmit=async e=>{
  e.preventDefault();
  const u=document.getElementById('user').value,p=document.getElementById('pass').value,b=document.getElementById('btn-login'),er=document.getElementById('err');
  b.disabled=true;b.textContent='...';er.classList.remove('show');
  try{
    const r=await fetch(API+'/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,password:p})});
    const d=await r.json();
    if(d.success){tk=d.token;localStorage.setItem('tk',tk);showApp();load();}else er.classList.add('show');
  }catch(x){er.textContent='Erro';er.classList.add('show');}
  b.disabled=false;b.textContent='Entrar';
};

async function logout(){await f('POST','/logout');doLogout();}

async function f(m,url,body){
  const o={method:m,headers:{Authorization:'Bearer '+tk}};
  if(body){o.headers['Content-Type']='application/json';o.body=JSON.stringify(body);}
  const r=await fetch(API+url,o);
  if(r.status===401){doLogout();return null;}
  return r.json();
}

async function load(){
  const[s,fo,le,ho]=await Promise.all([f('GET','/stats'),f('GET','/forms'),f('GET','/leads?limit=100'),f('GET','/webhooks')]);
  if(!s)return;
  D.stats=s.stats||{};D.forms=fo.forms||[];D.leads=(le.leads||[]).map(l=>({id:l.id,fid:l.form_id,fn:l.form_name,d:l.data,ws:l.webhook_sent,dt:l.created_at}));D.hooks=ho.webhooks||[];
  render();
}

function render(){
  document.getElementById('st-leads').textContent=D.stats.totalLeads||0;
  document.getElementById('st-forms').textContent=D.stats.totalForms||0;
  document.getElementById('st-hooks').textContent=D.stats.totalWebhooks||0;
  document.getElementById('st-sent').textContent=D.stats.webhooksSent||0;
  
  document.getElementById('tbl-forms').innerHTML=D.forms.length?D.forms.map(x=>`<tr><td><b>${x.name}</b></td><td>${x.fields.length}</td><td>${x.leads_count||0}</td><td><div class="actions"><button class="btn btn-secondary" onclick="showCode('${x.id}')">C√≥digo</button><button class="btn btn-secondary" onclick="delForm('${x.id}')" style="color:var(--accent)">üóëÔ∏è</button></div></td></tr>`).join(''):'<tr><td colspan="4" class="empty">Nenhum formul√°rio</td></tr>';
  
  const lh=D.leads.map(x=>`<tr><td>${x.d.nome||x.d.name||'-'}</td><td>${x.d.email||'-'}</td><td>${x.d.telefone||x.d.phone||'-'}</td><td>${x.fn||'-'}</td><td>${fdt(x.dt)}</td><td><span class="badge ${x.ws?'badge-ok':'badge-wait'}">${x.ws?'‚úì':'‚è≥'}</span></td></tr>`).join('');
  document.getElementById('tbl-leads').innerHTML=D.leads.length?lh:'<tr><td colspan="6" class="empty">Nenhum lead</td></tr>';
  document.getElementById('tbl-recent').innerHTML=D.leads.length?D.leads.slice(0,5).map(x=>`<tr><td>${x.d.nome||x.d.name||'-'}</td><td>${x.d.email||'-'}</td><td>${x.fn||'-'}</td><td>${fdt(x.dt)}</td><td><span class="badge ${x.ws?'badge-ok':'badge-wait'}">${x.ws?'‚úì':'‚è≥'}</span></td></tr>`).join(''):'<tr><td colspan="5" class="empty">Nenhum lead</td></tr>';
  
  document.getElementById('hook-list').innerHTML=D.hooks.map(h=>`<div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--bg2);border-radius:8px;margin-top:8px"><code style="font-size:11px;word-break:break-all">${h.url}</code><button class="btn btn-secondary" onclick="delHook(${h.id})" style="margin-left:12px;color:var(--accent)">üóëÔ∏è</button></div>`).join('');
}

document.querySelectorAll('.nav-item[data-v]').forEach(n=>n.onclick=()=>{
  document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active'));n.classList.add('active');
  document.querySelectorAll('.view').forEach(x=>x.classList.remove('active'));document.getElementById('v-'+n.dataset.v).classList.add('active');
});

function openM(n){document.getElementById('m-'+n).classList.add('active');if(n==='form'){TF=[{name:'Nome',type:'text',placeholder:'Seu nome',required:true},{name:'Email',type:'email',placeholder:'seu@email.com',required:true},{name:'Telefone',type:'tel',placeholder:'(00)00000-0000',required:false}];renderF();}}
function closeM(n){document.getElementById('m-'+n).classList.remove('active');}

function renderF(){document.getElementById('f-fields').innerHTML=TF.map((x,i)=>`<div class="field"><div class="field-info"><div class="field-name">${x.name}${x.required?' *':''}</div><div class="field-type">${x.type}</div></div><button class="field-del" onclick="rmField(${i})">üóëÔ∏è</button></div>`).join('');}

function addField(){
  const n=document.getElementById('fd-name').value,t=document.getElementById('fd-type').value,p=document.getElementById('fd-ph').value,r=document.getElementById('fd-req').checked;
  if(!n)return toast('Digite nome');
  TF.push({name:n,type:t,placeholder:p,required:r});renderF();closeM('field');
  document.getElementById('fd-name').value='';document.getElementById('fd-ph').value='';
}
function rmField(i){TF.splice(i,1);renderF();}

async function createForm(){
  const n=document.getElementById('f-name').value;
  if(!n)return toast('Digite nome');
  if(!TF.length)return toast('Adicione campos');
  const r=await f('POST','/forms',{name:n,fields:TF});
  if(r&&r.success){closeM('form');toast('Criado!');load();document.getElementById('f-name').value='';}
}

async function delForm(id){if(confirm('Excluir?')){await f('DELETE','/forms/'+id);toast('Exclu√≠do');load();}}

function showCode(id){
  const fo=D.forms.find(x=>x.id===id);if(!fo)return;
  const url=location.origin+'/api/leads';
  const flds=fo.fields.map(x=>{const k=x.name.toLowerCase().replace(/\s+/g,'_'),rq=x.required?'required':'';return x.type==='textarea'?`  <div><label>${x.name}</label><textarea name="${k}" placeholder="${x.placeholder||''}" ${rq}></textarea></div>`:`  <div><label>${x.name}</label><input type="${x.type}" name="${k}" placeholder="${x.placeholder||''}" ${rq}></div>`;}).join('\n');
  document.getElementById('code-out').textContent=`<form id="bf" onsubmit="return sendBF(event)">
${flds}
  <button type="submit">Enviar</button>
  <div id="bf-msg"></div>
</form>
<script>
async function sendBF(e){
  e.preventDefault();
  const b=e.target.querySelector('button'),m=document.getElementById('bf-msg');
  b.disabled=true;b.textContent='Enviando...';
  const fd=new FormData(e.target),data={formId:'${fo.id}',formName:'${fo.name}',data:{}};
  fd.forEach((v,k)=>data.data[k]=v);
  try{
    const r=await fetch('${url}',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
    if(r.ok){m.style.color='green';m.textContent='Enviado!';e.target.reset();}else throw 0;
  }catch(x){m.style.color='red';m.textContent='Erro';}
  b.disabled=false;b.textContent='Enviar';
  return false;
}
<\/script>
<style>
#bf{max-width:400px}#bf div{margin-bottom:16px}#bf label{display:block;margin-bottom:6px}
#bf input,#bf textarea{width:100%;padding:12px;border:1px solid #ddd;border-radius:6px}
#bf button{width:100%;padding:14px;background:#ef4444;color:#fff;border:none;border-radius:6px;cursor:pointer}
</style>`;
  openM('code');
}

function copyCode(){navigator.clipboard.writeText(document.getElementById('code-out').textContent);toast('Copiado!');}

async function saveHook(){
  const u=document.getElementById('hook-url').value;
  if(!u)return toast('Digite URL');
  await f('POST','/webhooks',{url:u,isGlobal:true});toast('Salvo!');load();document.getElementById('hook-url').value='';
}
async function delHook(id){await f('DELETE','/webhooks/'+id);toast('Removido');load();}

function csvExport(){window.open(API+'/leads/export/csv','_blank');}

function fdt(s){return new Date(s).toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit',year:'2-digit',hour:'2-digit',minute:'2-digit'});}

function toast(m){const t=document.createElement('div');t.className='toast';t.textContent=m;document.body.appendChild(t);setTimeout(()=>t.remove(),2500);}

init();
</script>
</body>
</html>
